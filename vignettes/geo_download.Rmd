---
title: "Downloading Data from GEO (Gene Expression Omnibus)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Downloading Data from GEO}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE  # Set to FALSE to avoid downloading during build
)
```

```{r setup}
library(RNAseqDataDownloader)
```

## Introduction

The `download_geo()` function provides a comprehensive interface to download various types of data from NCBI's Gene Expression Omnibus (GEO). This vignette demonstrates the key features and usage patterns, including the latest enhancements based on GEOquery 2.99.0+ best practices.

## Quick Start

The simplest way to download GEO data is to provide just an accession number:

```{r basic-download}
#devtools::install()
library(RNAseqDataDownloader)
# Download a GEO Series (GSE) - uses fast GSEMatrix format by default
result <- download_geo("GSE12345")
```

This downloads the series matrix files (fastest method), creates a directory `geo_data/GSE12345/`, and returns a list with the GEO object and metadata.

## Understanding GEO Accession Types

GEO has four main accession types:

- **GSE (Series)**: A complete study with multiple samples
- **GPL (Platform)**: Array or sequencing platform information
- **GSM (Sample)**: Individual sample data
- **GDS (Dataset)**: Curated dataset with comparable samples

## Basic Usage Examples

### Download a GEO Series (GSE)

```{r gse-download}
# Download series matrix (fastest, recommended)
result <- download_geo("GSE12345", data_type = "matrix")

# Access the data
geo_object <- result$geo_object  # List of ExpressionSet objects
metadata <- result$metadata      # Extracted metadata
files <- result$files            # Downloaded file paths

# For multi-platform GSE, geo_object is a list
if (is.list(geo_object)) {
  # First platform
  eset1 <- geo_object[[1]]
  
  # Get expression data
  expr_data <- Biobase::exprs(eset1)
  
  # Get sample information
  pheno_data <- Biobase::pData(eset1)
  
  # Get feature/probe information
  feature_data <- Biobase::fData(eset1)
}
```

### Download Platform Annotation (GPL)

```{r gpl-download}
# Download platform information
result <- download_geo("GPL570", data_type = "full")

# Access platform data
gpl_object <- result$geo_object
platform_info <- result$platform_info

# Get the annotation table
annotation_table <- GEOquery::Table(gpl_object)
```

### Download a Sample (GSM)

```{r gsm-download}
# Download individual sample
result <- download_geo("GSM123456", data_type = "full")

# Access sample information
gsm_object <- result$geo_object
sample_metadata <- result$metadata
```

### Download a Dataset (GDS)

```{r gds-download}
# Download curated dataset
result <- download_geo("GDS507", data_type = "full")

# GDS is converted to ExpressionSet automatically
eset <- result$geo_object
```

## Advanced Features

### 1. RNA-seq Quantification Data (NEW!)

For human and mouse datasets, NCBI provides pre-computed RNA-seq gene counts:

```{r rnaseq-download}
# Download RNA-seq quantification data
result <- download_geo("GSE164073", data_type = "rnaseq")

# Returns a SummarizedExperiment object
se <- result$geo_object

# Access count matrix
counts <- SummarizedExperiment::assay(se, "counts")

# Access sample metadata
sample_info <- SummarizedExperiment::colData(se)

# Access gene annotations
gene_info <- SummarizedExperiment::rowData(se)

# Check genome information
genome_info <- S4Vectors::metadata(se)
```

The RNA-seq data includes:
- Raw gene counts processed by NCBI
- HISAT2 alignment + featureCounts quantification
- Sample metadata from GEO
- Gene annotations

### 2. Download with Annotation GPL

Use updated gene annotations with current Entrez Gene mappings:

```{r annotgpl}
# Download with updated annotations
result <- download_geo("GSE12345", 
                      data_type = "matrix",
                      AnnotGPL = TRUE)

# The feature data will have updated gene symbols and annotations
eset <- result$geo_object[[1]]
fdata <- Biobase::fData(eset)

# Check what annotation columns are available
colnames(fdata)
```

### 3. Download Both Matrix and Raw Data

```{r both-download}
# Download both matrix files and supplementary files
result <- download_geo("GSE12345", 
                      data_type = "both",
                      output_dir = "my_geo_data")

# You get both:
# 1. Processed expression matrices (in geo_object)
# 2. Raw supplementary files (CEL, FASTQ, etc.)
```

### 4. Filter Supplementary Files

Download only specific file types from supplementary files:

```{r filter-files}
# Download only .cel.gz files
result <- download_geo("GSE12345", 
                      data_type = "raw",
                      filter_files = "\\.cel\\.gz$")

# Download only text files
result <- download_geo("GSE12345", 
                      data_type = "raw",
                      filter_files = "\\.txt(\\.gz)?$")

# Download only count matrices
result <- download_geo("GSE12345", 
                      data_type = "raw",
                      filter_files = "counts.*\\.txt")
```

### 5. Multi-Platform Handling

When a GSE has multiple platforms, filter to specific ones:

```{r platform-filter}
# Download data from specific platform only
result <- download_geo("GSE12345", 
                      data_type = "matrix",
                      platform = "GPL570")

# Download from multiple platforms
result <- download_geo("GSE12345", 
                      data_type = "matrix",
                      platform = c("GPL570", "GPL96"))
```

### 6. Sample Filtering

Download specific samples from a series:

```{r sample-filter}
# Download only specific samples
result <- download_geo("GSE12345",
                      samples = c("GSM123", "GSM124", "GSM125"))
```

### 7. Control Archive Extraction

```{r extract-control}
# Don't automatically extract compressed files
result <- download_geo("GSE12345", 
                      data_type = "raw",
                      extract_archives = FALSE)

# Extract manually later if needed
```

### 8. Enhanced Error Handling

```{r error-handling}
# Set custom retry and timeout
result <- download_geo("GSE12345",
                      max_retries = 5,
                      timeout = 600,  # 10 minutes
                      verbose = TRUE)
```

## Practical Workflows

### Workflow 1: Download and Analyze Microarray Data

```{r workflow-microarray}
# 1. Download the data
result <- download_geo("GSE12345", 
                      data_type = "matrix",
                      AnnotGPL = TRUE)

# 2. Extract the ExpressionSet
eset <- result$geo_object[[1]]

# 3. Get expression data and phenotype info
expr_matrix <- Biobase::exprs(eset)
pheno <- Biobase::pData(eset)

# 4. Check the data
dim(expr_matrix)  # genes x samples
head(pheno[, 1:5])  # first 5 phenotype columns

# 5. Perform your analysis
# (e.g., differential expression with limma)
```

### Workflow 2: Download RNA-seq Data for Analysis

```{r workflow-rnaseq}
# 1. Download RNA-seq quantification
result <- download_geo("GSE164073", data_type = "rnaseq")

# 2. Get the SummarizedExperiment
se <- result$geo_object

# 3. Extract components
counts <- SummarizedExperiment::assay(se, "counts")
metadata <- SummarizedExperiment::colData(se)

# 4. Use with DESeq2 or other tools
# library(DESeq2)
# dds <- DESeqDataSet(se, design = ~ condition)
# dds <- DESeq(dds)
```

### Workflow 3: Download Raw Data for Custom Processing

```{r workflow-raw}
# 1. Download supplementary files only
result <- download_geo("GSE12345", 
                      data_type = "raw",
                      filter_files = "\\.fastq\\.gz$",
                      output_dir = "raw_data")

# 2. Check downloaded files
downloaded_files <- result$files
print(downloaded_files)

# 3. Process with your custom pipeline
# (alignment, quantification, etc.)
```

### Workflow 4: Comprehensive Download

```{r workflow-comprehensive}
# Download everything with all options
result <- download_geo(
  accession = "GSE12345",
  output_dir = "complete_download",
  data_type = "both",
  platform = "GPL570",
  getGPL = TRUE,
  AnnotGPL = TRUE,
  extract_archives = TRUE,
  filter_files = NULL,
  force_download = FALSE,
  max_retries = 3,
  timeout = 600,
  parseCharacteristics = TRUE,
  verbose = TRUE
)

# Access all components
geo_obj <- result$geo_object      # GEO data objects
metadata <- result$metadata        # Extracted metadata
platform <- result$platform_info   # Platform details
files <- result$files              # All downloaded files
success <- result$success          # Download success status
```

## Working with Results

### Extracting Metadata

```{r metadata-extraction}
result <- download_geo("GSE12345")

# Check metadata structure
str(result$metadata)

# For multi-platform GSE
if (!is.null(result$metadata$platforms)) {
  # Get information for each platform
  for (platform_id in names(result$metadata$platforms)) {
    platform_data <- result$metadata$platforms[[platform_id]]
    cat("Platform:", platform_id, "\n")
    cat("  Samples:", platform_data$n_samples, "\n")
    cat("  Features:", platform_data$n_features, "\n")
  }
}
```

### Saving and Loading Results

```{r save-load}
# Download data
result <- download_geo("GSE12345", output_dir = "my_data")

# Save the result object
saveRDS(result, "my_data/GSE12345/download_result.rds")

# Later, reload it
result <- readRDS("my_data/GSE12345/download_result.rds")

# The GEO object is also automatically saved as .rds files
```

### Converting to Different Formats

```{r format-conversion}
# Get ExpressionSet
eset <- result$geo_object[[1]]

# Convert to data frame
expr_df <- as.data.frame(Biobase::exprs(eset))
pheno_df <- as.data.frame(Biobase::pData(eset))

# Save as CSV
write.csv(expr_df, "expression_data.csv")
write.csv(pheno_df, "phenotype_data.csv")

# Or use the convert_geo_format helper function if available
# See extract_geo_metadata() for more options
```

## Performance Tips

1. **Use GSEMatrix format** (default): 10-100x faster than SOFT format
2. **Specify platform**: Reduces download time for multi-platform GSE
3. **Filter files**: Download only what you need with `filter_files`
4. **Use local cache**: Re-running won't re-download if files exist
5. **Set appropriate timeout**: Large files may need longer timeout

```{r performance}
# Optimized download
result <- download_geo(
  "GSE12345",
  data_type = "matrix",      # Fastest format
  platform = "GPL570",       # Specific platform
  getGPL = FALSE,           # Skip GPL if not needed
  timeout = 300             # Adjust for file size
)
```

## Troubleshooting

### No RNA-seq Data Available

```{r troubleshoot-rnaseq}
result <- download_geo("GSE12345", data_type = "rnaseq")
# If RNA-seq data not available, automatically falls back to matrix download
```

### Large File Downloads

```{r troubleshoot-large}
# Increase timeout for large files
result <- download_geo("GSE12345", 
                      timeout = 1200,  # 20 minutes
                      max_retries = 5)
```

### Network Issues

```{r troubleshoot-network}
# Enhanced retry with exponential backoff
result <- download_geo("GSE12345",
                      max_retries = 5,
                      verbose = TRUE)  # See detailed progress
```

### Memory Issues with Large GSE

```{r troubleshoot-memory}
# Download raw files instead of matrix
result <- download_geo("GSE12345", data_type = "raw")

# Or download specific samples
result <- download_geo("GSE12345", 
                      samples = c("GSM1", "GSM2", "GSM3"))
```

## Additional Features

### Check Available Databases

```{r check-databases}
# See all available databases
available_databases()
```

### Batch Download (if available)

```{r batch-download}
# Download multiple accessions
accessions <- c("GSE12345", "GSE67890", "GSE11111")

results <- lapply(accessions, function(acc) {
  download_geo(acc, 
              data_type = "matrix",
              output_dir = paste0("geo_data/", acc))
})
```

## Summary

The `download_geo()` function provides:

- **Fast downloads**: GSEMatrix format (10-100x faster)
- **RNA-seq support**: Pre-computed gene counts from NCBI
- **Flexible filtering**: Platform, sample, and file filtering
- **Updated annotations**: AnnotGPL with current gene mappings
- **Robust handling**: Automatic retries and error recovery
- **Comprehensive output**: Expression data, metadata, and files

## See Also

- `?download_geo` - Full function documentation
- `?extract_geo_metadata` - Extract and work with GEO metadata
- GEOquery package: https://bioconductor.org/packages/GEOquery
- GEO website: https://www.ncbi.nlm.nih.gov/geo/

## Batch Download Example

For downloading multiple GEO datasets, you can use a batch processing approach:

```{r batch-download}
# Define your list of GSE IDs
gse_list <- c("GSE102628", "GSE102641", "GSE102725", "GSE103489", "GSE104509", 
              "GSE106087", "GSE106992", "GSE107361", "GSE107871", "GSE109182")

# Download all datasets with error handling
results <- list(success = character(), failed = character())

for (gse_id in gse_list) {
  cat(sprintf("Downloading %s...\n", gse_id))
  
  tryCatch({
    result <- download_geo(
      accession = gse_id,
      output_dir = "geo_batch_data",
      data_type = "matrix",
      verbose = FALSE
    )
    
    if (result$success) {
      results$success <- c(results$success, gse_id)
      cat(sprintf("✓ SUCCESS: %s\n", gse_id))
    }
  }, error = function(e) {
    results$failed <- c(results$failed, gse_id)
    cat(sprintf("✗ ERROR: %s - %s\n", gse_id, e$message))
  })
  
  # Delay between downloads to be respectful to NCBI servers
  Sys.sleep(2)
}

# Summary
cat(sprintf("\nCompleted: %d successful, %d failed\n", 
            length(results$success), length(results$failed)))
```

### Using the Batch Download Script

A complete batch download script is available in the package:

```{r batch-script, eval=FALSE}
# Source the script
source(system.file("download_gse_list.R", package = "RNAseqDataDownloader"))

# Or run from command line:
# Rscript download_gse_list.R [output_directory]

# The script includes:
# - Pre-defined list of 140+ GEO datasets
# - Progress tracking and logging
# - Error handling with detailed logs
# - Automatic retry logic
# - Summary statistics
```

### Large-Scale Dataset List

Here's the complete list of datasets used in the batch download script:

```{r dataset-list, eval=FALSE}
gse_datasets <- c(
  "GSE102628", "GSE102641", "GSE102725", "GSE103489", "GSE104509", "GSE106087",
  "GSE106992", "GSE107361", "GSE107871", "GSE109182", "GSE109248", "GSE111053",
  "GSE111054", "GSE111055", "GSE11307", "GSE114286", "GSE114729", "GSE116486",
  "GSE117239", "GSE117405", "GSE11903", "GSE120721", "GSE120899", "GSE121212",
  "GSE123785", "GSE123786", "GSE123787", "GSE124700", "GSE124701", "GSE130588",
  "GSE133385", "GSE133477", "GSE13355", "GSE14905", "GSE16161", "GSE18686",
  "GSE18948", "GSE20264", "GSE24767", "GSE26866", "GSE26952", "GSE2737",
  "GSE27887", "GSE30355", "GSE30768", "GSE30999", "GSE31652", "GSE32407",
  "GSE32473", "GSE32620", "GSE32924", "GSE34248", "GSE36381", "GSE36387",
  "GSE36842", "GSE38039", "GSE40033", "GSE40263", "GSE41662", "GSE41663",
  "GSE41664", "GSE41745", "GSE41905", "GSE42305", "GSE42632", "GSE47598",
  "GSE47751", "GSE47944", "GSE47965", "GSE48586", "GSE50598", "GSE50614",
  "GSE50790", "GSE51440", "GSE52361", "GSE52471", "GSE53431", "GSE53552",
  "GSE54456", "GSE55201", "GSE5667", "GSE57225", "GSE57376", "GSE57383",
  "GSE57386", "GSE57405", "GSE58121", "GSE58558", "GSE58749", "GSE59294",
  "GSE60481", "GSE60709", "GSE60971", "GSE61281", "GSE62408", "GSE63079",
  "GSE63741", "GSE63979", "GSE63980", "GSE121212", "GSE141570", "GSE65832",
  "GSE6601", "GSE66511", "GSE6710", "GSE67785", "GSE67853", "GSE68923",
  "GSE68924", "GSE68939", "GSE69967", "GSE72246", "GSE74697", "GSE75343",
  "GSE75890", "GSE77719", "GSE78023", "GSE78097", "GSE79704", "GSE80047",
  "GSE80429", "GSE82140", "GSE83582", "GSE83645", "GSE85034", "GSE86451",
  "GSE89725", "GSE92472", "GSE93423", "GSE99802", "GSE224783", "GSE140684",
  "GSE15719", "GSE95759", "GSE67785", "GSE157194", "GSE182740", "GSE261704",
  "GSE283265"
)

# Total: 143 unique datasets
length(unique(gse_datasets))
```

## Post-processing Downloaded Matrices

Once batches finish, the helper functions `load_geo_batch_matrices()` and
`combine_geo_matrices()` simplify loading every downloaded series matrix and
combining them into one tidy table.

```{r load-batch-matrices, eval=FALSE}
# Load all matrix files inside "geo_batch_data" into a named list
matrix_list <- load_geo_batch_matrices(
  base_dir = "geo_batch_data",
  pattern = "_series_matrix.txt.gz",
  simplify = TRUE,
  verbose = TRUE
)

# Inspect one entry
names(matrix_list)[1]
dim(matrix_list[[1]])
```

Each list element name looks like `GSE102628-GPL20148_series_matrix`. The
function reads the expression matrix with GEOquery, returning a numeric matrix
with features as rows and samples as columns.

To analyze all matrices at once, convert them into a long-format table and add
the originating GEO accession via `combine_geo_matrices()`:

```{r combine-batch-matrices, eval=FALSE}
combined_geo <- combine_geo_matrices(
  matrices = matrix_list,
  drop_na = TRUE,
  verbose = TRUE
)

head(combined_geo)
unique(combined_geo$GEOcode)[1:5]
```

The resulting data frame contains four columns:

- `GEOcode` — derived from the matrix file name (e.g., `GSE99802`)
- `Feature` — probe/gene identifier
- `Sample` — GEO sample ID
- `Value` — expression/intensity value

For very large batches (hundreds of matrices), consider writing `combined_geo`
to disk or processing it with packages such as `data.table`, `arrow`, or
`duckdb` to stay within memory limits.

## Session Info

```{r session-info, eval=TRUE}
sessionInfo()
```
